- name: EC2インスタンス作成
  hosts: localhost
  connection: local
  gather_facts: False
  vars:
    keypair_name: dev-key
    ec2_name: test-ec2
    region: ap-northeast-1
    security_group_name: all_ssh
    elastic_ip: 52.198.108.124
    id: imagesearch8
  tasks:
    - name: AWSに認証鍵を登録
      ec2_key:
        name: "{{ keypair_name }}"
      register: keypair_regst

    - name: 認証鍵ファイル生成（権限：0400）
      file:
        path=~/.ssh/{{ keypair_regst.key.name }}.pem
        state=touch
        mode=0400

    - name: 認証鍵ファイルにデータを追加
      shell: echo "{{ keypair_regst.key.private_key }}" > ~/.ssh/{{ keypair_name }}.pem
      when: keypair_regst.key.private_key is defined

    - name: create_security_group
      ec2_group:
        name: "{{ security_group_name }}"
        description: all_ssh
        rules:
          - proto: tcp
            ports:
              - 22
              - 80
            cidr_ip: 0.0.0.0/0

    - name: EC2インスタンスの生成
      ec2:
        id: "{{ id }}"
        instance_tags:
          Name: "{{ ec2_name }}"
        key_name: "{{ keypair_name }}"
        instance_type: t2.small
        image: ami-0ff21806645c5e492
        region: "{{ region }}"
        group: "{{ security_group_name }}"
        wait: yes
      register: ec2_regst

    - name: インベントリにホストを追加
      add_host:
        groups=my_host
        name="{{ ec2_regst.instances[0].public_ip }}"

    - name: 作成したEC2が接続可能状態になるまで待つ
      wait_for: port=22 host="{{ ec2_regst.instances[0].public_ip }}" delay=10  timeout=300

    - name: associate an elastic IP with an instance
      ec2_eip:
        device_id: "{{ ec2_regst.instances[0].id }}"
        ip: "{{ elastic_ip }}"

- name: EC2インスタンスで作業
  hosts: my_host
  user: ec2-user
  become: yes
  environment:
    PATH: "/root/.gem/ruby/2.5.0/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin"
  roles:
    - galaxy/geerlingguy.ruby
    - imagesearch_main
    - ffmpeg_install