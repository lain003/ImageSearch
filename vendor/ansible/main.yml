- hosts: localhost
  tasks:
    - name: install git etc...
      yum:
        name: "{{ item }}"
        state: present
      with_items:
        - git
        - gcc
        - openssl-devel
        - readline-devel
        - zlib-devel
        - sqlite-devel
        - gcc-c++
        - libicu-devel
        - cmake
        - bzip2
        - mysql-devel
        - java-1.8.0-openjdk
        - java-1.8.0-openjdk-devel
        - java-sdk
        - initscripts

    - name: java8 version selected
      alternatives:
        name: java
        path: /usr/lib/jvm/jre-1.8.0-openjdk.x86_64/bin/java

    - name: Is Ruby Installed?
      shell: ruby -v
      failed_when: false
      register: ruby_install
      changed_when: '"ruby 2.5.1" not in ruby_install.stdout'
    - name: download_ruby_build
      git:
        repo: 'https://github.com/rbenv/ruby-build.git'
        dest: /root/ruby-build
      register: result
    - name: shell
      shell: /root/ruby-build/install.sh
      when: result.changed
    - name: ruby install
      shell: ruby-build 2.5.1 /opt/ruby-2.5.1 --verbose
      when: result.changed
    - name: add_path
      shell: echo 'export PATH=/opt/ruby-2.5.1/bin:$PATH' >> /root/.bash_profile
      when: result.changed
    - name: add_manpath
      shell: echo 'export MANPATH=:/opt/ruby-2.5.1/share/man' >> /root/.bash_profile
      when: result.changed
    - name: synbo link to ansible gem
      shell: ln -s /opt/ruby-2.5.1/bin/gem /usr/local/sbin/gem
      when: result.changed

    - name: rails install
      gem:
        name: rails
        version: 5.1.5
        user_install: no

    - name: yum add elasticsearch
      template:
        src: template/elasticsearch.repo
        dest: /etc/yum.repos.d/elasticsearch.repo
    - name: elasticsearch install
      yum:
        name: elasticsearch
    - name: elastichsearch start
      service:
        name: elasticsearch
        state: started
        enabled: yes
    - name: kuromozi install
      shell: /usr/share/elasticsearch/bin/elasticsearch-plugin install analysis-kuromoji
      register: result
      failed_when: false
      changed_when: '"already exists" not in result.stdout'

    - name: install bundle
      gem:
        name: bundler
        state: present
        user_install: no

    - name: project bundle install
      bundler:
        state: present
        chdir: /root/imagesearch
        executable: /opt/ruby-2.5.1/bin/bundle

    - name: install nginx
      yum:
        name: "{{ item }}"
        state: present
      with_items:
        - nginx
    - name: copy nginx conf
      template:
        src: template/nginx/nginx.conf
        dest: /etc/nginx/nginx.conf

    - name: create nginx directory
      file:
        path: /etc/nginx/sites
        state: directory

    - name: copy virtual host conf
      template:
        src: template/nginx/imagesearch.conf
        dest: /etc/nginx/sites/imagesearch.conf

    - name: Is ffmpeg Installed?
      shell: ffmpeg
      failed_when: false
      register: ffmpeg_result
      changed_when: '"command not found" in ffmpeg_result.stdout'


- hosts: localhost
  roles:
    - { role: ffmpeg_install, when: "ffmpeg_result.changed"}