- name: install git etc...
  yum:
    name: "{{ packages }}"
    state: present
  vars:
    packages:
      - git
      - gcc
      - openssl-devel
      - readline-devel
      - zlib-devel
      - sqlite-devel
      - gcc-c++
      - libicu-devel
      - cmake
      - bzip2
      - mysql-devel
      - java-1.8.0-openjdk
      - java-1.8.0-openjdk-devel
      - java-sdk
      - initscripts
      - mecab
      - mecab-ipadic-utf8

- name: yum add elasticsearch
  template:
    src: template/elasticsearch.repo
    dest: /etc/yum.repos.d/elasticsearch.repo
- name: elasticsearch install
  yum:
    name: elasticsearch
- name: elastichsearch start
  service:
    name: elasticsearch
    state: started
    enabled: yes
- name: kuromozi install
  shell: /usr/share/elasticsearch/bin/elasticsearch-plugin install analysis-kuromoji
  register: result
  failed_when: false
  changed_when: '"already exists" not in result.stdout'

- shell: amazon-linux-extras install epel
- yum:
    name: https://packages.groonga.org/centos/groonga-release-latest.noarch.rpm
- name: install mecab
  yum:
    name: "{{ packages }}"
    state: present
  vars:
    packages:
      - mecab
      - mecab-ipadic

- name: clone repository
  git:
    repo: https://github.com/lain003/ImageSearch.git
    dest: /root/imagesearch

# Cannot allocate memoryで落ちた場合は手動で実行
- name: project bundle install
  bundler:
    state: present
    chdir: /root/imagesearch

- name: install nginx
  shell: yes | amazon-linux-extras install nginx1.12
- name: copy nginx conf
  template:
    src: template/nginx/nginx.conf
    dest: /etc/nginx/nginx.conf
- name: create nginx directory
  file:
    path: /etc/nginx/sites
    state: directory
- name: copy virtual host conf
  template:
    src: template/nginx/imagesearch.conf
    dest: /etc/nginx/sites/imagesearch.conf

- name: nginxのサービススタート
  service:
    name: nginx
    enabled: yes
